name: Test GitHub Action

on:
  push:
    branches: [main]
    paths:
      - '.github/actions/mkdlint/**'
      - '.github/workflows/test-action.yml'
  pull_request:
    paths:
      - '.github/actions/mkdlint/**'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:

jobs:
  test-binary-download-linux:
    name: Test Binary Download (Linux)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Test with latest version
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          fail-on-error: false
          upload-sarif: false

      - name: Test with specific version
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          version: 'v0.3.2'
          fail-on-error: false
          upload-sarif: false

  test-binary-download-macos:
    name: Test Binary Download (macOS)
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Test with latest version
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          fail-on-error: false
          upload-sarif: false

  test-binary-download-windows:
    name: Test Binary Download (Windows)
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Test with latest version
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          fail-on-error: false
          upload-sarif: false

  test-cargo-build:
    name: Test Cargo Build Fallback
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Force cargo build
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          use-binary: false
          version: '0.3.2'
          fail-on-error: false
          upload-sarif: false

  test-sarif-generation:
    name: Test SARIF Generation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create test file with errors
        run: |
          mkdir -p test-files
          cat > test-files/test.md << 'EOF'
          # Heading


          Multiple blank lines above (MD012)

          #No space after hash (MD018)

          [Empty link]()
          EOF

      - name: Run with SARIF output
        id: lint
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-files/'
          output-format: 'sarif'
          sarif-file: 'results.sarif'
          fail-on-error: false
          upload-sarif: false

      - name: Verify SARIF file exists
        run: |
          if [ ! -f "results.sarif" ]; then
            echo "::error::SARIF file not found"
            exit 1
          fi
          echo "✓ SARIF file generated"

      - name: Verify SARIF content
        run: |
          if ! grep -q "mkdlint" results.sarif; then
            echo "::error::SARIF file doesn't contain mkdlint tool info"
            exit 1
          fi
          echo "✓ SARIF file contains tool info"

      - name: Check outputs
        run: |
          echo "Exit code: ${{ steps.lint.outputs.exit-code }}"
          echo "Error count: ${{ steps.lint.outputs.error-count }}"
          echo "File count: ${{ steps.lint.outputs.file-count }}"
          echo "SARIF file: ${{ steps.lint.outputs.sarif-file }}"

  test-sarif-upload:
    name: Test SARIF Upload to Code Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Create test file with errors
        run: |
          mkdir -p test-sarif
          cat > test-sarif/test.md << 'EOF'
          # Test Document

          #Missing space
          EOF

      - name: Run with SARIF upload
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-sarif/'
          output-format: 'sarif'
          upload-sarif: true
          fail-on-error: false

  test-auto-fix:
    name: Test Auto-Fix
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Create test file with fixable errors
        run: |
          mkdir -p test-fix
          cat > test-fix/fixable.md << 'EOF'
          #Missing space after hash

          # Heading #No space before hash

          [Empty link]()
          EOF

      - name: Run with fix enabled
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-fix/'
          fix: true
          fail-on-error: false
          upload-sarif: false

      - name: Verify fixes were applied
        run: |
          if grep -q "#Missing" test-fix/fixable.md; then
            echo "::error::Fixes were not applied"
            exit 1
          fi
          echo "✓ Fixes were applied successfully"

  test-custom-config:
    name: Test Custom Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create custom config
        run: |
          mkdir -p test-config
          cat > test-config/.markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false
          }
          EOF

      - name: Create test file
        run: |
          cat > test-config/test.md << 'EOF'
          # Test

          This is a very long line that would normally trigger MD013 but should be ignored with our config.

          <div>HTML should be allowed</div>
          EOF

      - name: Run with custom config
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-config/test.md'
          config: 'test-config/.markdownlint.json'
          fail-on-error: true
          upload-sarif: false

  test-ignore-patterns:
    name: Test Ignore Patterns
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create test structure
        run: |
          mkdir -p test-ignore/node_modules test-ignore/docs
          echo "#Bad heading" > test-ignore/node_modules/test.md
          echo "#Bad heading" > test-ignore/docs/test.md

      - name: Run with ignore patterns
        id: lint
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-ignore/'
          ignore: '**/node_modules/**'
          fail-on-error: false
          upload-sarif: false

      - name: Verify only docs were linted
        run: |
          # Should find error in docs but not in node_modules
          if [ "${{ steps.lint.outputs.file-count }}" != "1" ]; then
            echo "::error::Expected 1 file with errors, got ${{ steps.lint.outputs.file-count }}"
            exit 1
          fi
          echo "✓ Ignore patterns working correctly"

  test-enable-disable-rules:
    name: Test Enable/Disable Rules
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create test file
        run: |
          mkdir -p test-rules
          cat > test-rules/test.md << 'EOF'
          #No space (MD018)



          Multiple blanks (MD012)
          EOF

      - name: Run with MD018 disabled
        id: lint-disabled
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-rules/'
          disable: 'MD018'
          fail-on-error: false
          upload-sarif: false

      - name: Verify MD018 was ignored
        run: |
          echo "Errors found: ${{ steps.lint-disabled.outputs.error-count }}"
          # Should only find MD012, not MD018
          if [ "${{ steps.lint-disabled.outputs.error-count }}" = "0" ]; then
            echo "::error::Expected some errors (MD012) but got none"
            exit 1
          fi
          echo "✓ Rule disabling works"

  test-json-output:
    name: Test JSON Output Format
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create test file
        run: |
          mkdir -p test-json
          echo "#Bad" > test-json/test.md

      - name: Run with JSON output
        id: lint
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-json/'
          output-format: 'json'
          fail-on-error: false
          upload-sarif: false

      - name: Check outputs
        run: |
          echo "Exit code: ${{ steps.lint.outputs.exit-code }}"
          echo "Error count: ${{ steps.lint.outputs.error-count }}"
          echo "No SARIF file: ${{ steps.lint.outputs.sarif-file }}"

  test-text-output:
    name: Test Text Output Format
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Run with text output
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          output-format: 'text'
          fail-on-error: false
          upload-sarif: false

  test-verbose-output:
    name: Test Verbose Mode
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Run with verbose output
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          verbose: true
          fail-on-error: false
          upload-sarif: false

  test-quiet-mode:
    name: Test Quiet Mode
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Run in quiet mode
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          quiet: true
          fail-on-error: false
          upload-sarif: false

  test-failure-modes:
    name: Test Failure Behavior
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create file with errors
        run: |
          mkdir -p test-fail
          echo "#Bad" > test-fail/test.md

      - name: Test fail-on-error false
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-fail/'
          fail-on-error: false
          upload-sarif: false

      - name: Test fail-on-error true (expect failure)
        id: should-fail
        continue-on-error: true
        uses: ./.github/actions/mkdlint
        with:
          files: 'test-fail/'
          fail-on-error: true
          upload-sarif: false

      - name: Verify it failed
        run: |
          if [ "${{ steps.should-fail.outcome }}" != "failure" ]; then
            echo "::error::Expected step to fail but it succeeded"
            exit 1
          fi
          echo "✓ fail-on-error=true works correctly"

  test-working-directory:
    name: Test Working Directory
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Create subdirectory structure
        run: |
          mkdir -p subdir/docs
          echo "# Test" > subdir/docs/test.md

      - name: Run from working directory
        uses: ./.github/actions/mkdlint
        with:
          files: 'docs/'
          working-directory: 'subdir'
          fail-on-error: false
          upload-sarif: false

  test-cache-performance:
    name: Test Binary Caching
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: First run (no cache)
        id: first-run
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          cache-binary: true
          fail-on-error: false
          upload-sarif: false

      - name: Second run (should use cache)
        id: second-run
        uses: ./.github/actions/mkdlint
        with:
          files: 'README.md'
          cache-binary: true
          fail-on-error: false
          upload-sarif: false

      - name: Verify cache was used
        run: |
          echo "First run cache hit: ${{ steps.first-run.outputs.cache-hit }}"
          echo "Second run cache hit: ${{ steps.second-run.outputs.cache-hit }}"
          if [ "${{ steps.second-run.outputs.cache-hit }}" = "true" ]; then
            echo "✓ Cache is working"
          else
            echo "⚠ Cache not hit on second run (may be expected in some cases)"
          fi

  integration-test:
    name: Full Integration Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Create comprehensive test structure
        run: |
          mkdir -p integration-test/{good,bad,config}

          # Good markdown
          cat > integration-test/good/good.md << 'EOF'
          # Good Document

          This is properly formatted markdown.

          ## Section

          - List item 1
          - List item 2
          EOF

          # Bad markdown
          cat > integration-test/bad/bad.md << 'EOF'
          #Bad heading



          Multiple blank lines

          [Empty link]()
          EOF

          # Config
          cat > integration-test/config/.markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false
          }
          EOF

      - name: Run full integration test
        id: integration
        uses: ./.github/actions/mkdlint
        with:
          files: 'integration-test/'
          config: 'integration-test/config/.markdownlint.json'
          output-format: 'sarif'
          upload-sarif: true
          fail-on-error: false

      - name: Verify all outputs
        run: |
          echo "=== Integration Test Results ==="
          echo "Exit code: ${{ steps.integration.outputs.exit-code }}"
          echo "Error count: ${{ steps.integration.outputs.error-count }}"
          echo "File count: ${{ steps.integration.outputs.file-count }}"
          echo "SARIF file: ${{ steps.integration.outputs.sarif-file }}"
          echo "Binary path: ${{ steps.integration.outputs.binary-path }}"
          echo "Cache hit: ${{ steps.integration.outputs.cache-hit }}"

          # Should find errors in bad.md but not good.md
          if [ "${{ steps.integration.outputs.file-count }}" != "1" ]; then
            echo "::warning::Expected 1 file with errors, got ${{ steps.integration.outputs.file-count }}"
          fi

          echo "✓ Integration test complete"
